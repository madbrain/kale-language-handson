<!DOCTYPE HTML>
<html lang="fr" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Extension VSCode - Kale Language Hands&#x27;on</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Le langage Kale et son interpréteur</li><li class="chapter-item expanded "><a href="../01_Interpreteur/01_Preparation.html"><strong aria-hidden="true">1.</strong> Préparation</a></li><li class="chapter-item expanded "><a href="../01_Interpreteur/02_Lexer.html"><strong aria-hidden="true">2.</strong> Analyseur Lexical</a></li><li class="chapter-item expanded "><a href="../01_Interpreteur/03_Parser.html"><strong aria-hidden="true">3.</strong> Analyseur Grammatical</a></li><li class="chapter-item expanded "><a href="../01_Interpreteur/04_Interpreteur.html"><strong aria-hidden="true">4.</strong> Interpréteur</a></li><li class="chapter-item expanded affix "><li class="part-title">Un langage robuste</li><li class="chapter-item expanded "><a href="../02_Robustesse/01_Reporting.html"><strong aria-hidden="true">5.</strong> Préparation</a></li><li class="chapter-item expanded "><a href="../02_Robustesse/02_Lexer.html"><strong aria-hidden="true">6.</strong> Lexer</a></li><li class="chapter-item expanded "><a href="../02_Robustesse/03_Parser.html"><strong aria-hidden="true">7.</strong> Parser</a></li><li class="chapter-item expanded "><a href="../02_Robustesse/04_Semantique.html"><strong aria-hidden="true">8.</strong> Sémantique</a></li><li class="chapter-item expanded affix "><li class="part-title">Serveur de langage</li><li class="chapter-item expanded "><a href="../03_ExtensionVSCode/01_Decouverte.html"><strong aria-hidden="true">9.</strong> Découverte</a></li><li class="chapter-item expanded "><a href="../03_ExtensionVSCode/02_ServeurLangage.html"><strong aria-hidden="true">10.</strong> Serveur de langage Kale</a></li><li class="chapter-item expanded "><a href="../03_ExtensionVSCode/03_ExtensionVSCode.html" class="active"><strong aria-hidden="true">11.</strong> Extension VSCode</a></li><li class="chapter-item expanded "><a href="../03_ExtensionVSCode/04_ExtensionVim.html"><strong aria-hidden="true">12.</strong> Extension Vim</a></li><li class="chapter-item expanded affix "><li class="part-title">Vers de l'outillage de pro</li><li class="chapter-item expanded "><a href="../04_Amelioration/01_Preparation.html"><strong aria-hidden="true">13.</strong> Langage amélioré</a></li><li class="chapter-item expanded "><a href="../05_AdvanceFeatures/01_Preparation.html"><strong aria-hidden="true">14.</strong> Fonctionnalités avancées</a></li><li class="chapter-item expanded affix "><a href="../06_Conclusion/01_Conclusion.html">Conclusion</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Kale Language Hands&#x27;on</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="initialisation-du-projet-dextension-vscode"><a class="header" href="#initialisation-du-projet-dextension-vscode">Initialisation du projet d'extension VSCode</a></h1>
<p>La première étape consiste à créer le projet correspondant à l'extension VSCode.
La procédure est tirée de <a href="https://code.visualstudio.com/docs/extensions/example-hello-world">la documentation officielle</a>
de VSCode et utilise le générateur de code <a href="http://yeoman.io/">Yeoman</a>.</p>
<pre><code>npm install -g yo generator-code
yo code
</code></pre>
<p>Répondez aux questions dans l'ordre :</p>
<ul>
<li><code>New Extension (Typescript)</code> pour le type d'extension</li>
<li><code>Kale Extension</code> comme nom d'extension</li>
<li><code>kale-extension</code> comme identifiant de l'extension</li>
<li>entrez une description</li>
<li>et choisissez ou pas d'initialiser un dépôt Git</li>
<li>enfin choisissez le gestionnaire de package npm</li>
</ul>
<p>Le projet généré est un projet VSCode, ouvrez l'IDE avec la commande :</p>
<pre><code>code kale-extension
</code></pre>
<p>Le fichier <code>package.json</code> est le point d'entrée de l'extension (l'extension elle même est un package Node).
Il déclare une nouvelle commande <code>extension.sayHello</code> et indique que l'extension est activée lorsque cette
commande est invoquée.</p>
<p>Tout le code de l'extension est dans le fichier <code>src/extension.ts</code>.
Il comporte deux fonctions obligatoires <code>activate</code> et <code>deactivate</code>.
La première, appelée au démarrage de l'extension, donne la définition de la commande qui permet d'afficher
le fameux message d'information <code>Hello world!</code>.</p>
<p>Démarrez l'extension comme indiqué dans la documentation en appuyant sur la touche <code>F5</code>.
Une nouvelle instance de l'IDE démarre avec la nouvelle extension disponible.
Lancer la commande Hello en appuyant sur <code>F1</code> et en sélectionnant la commande : le message s'affiche dans un toaster.</p>
<p>Remarquer également l'affichage du log dans la console lors de l'activation de l'extension.</p>
<h1 id="définition-des-contributions-de-lextension"><a class="header" href="#définition-des-contributions-de-lextension">Définition des contributions de l'extension</a></h1>
<p>Notre extension va permettre de gérer un nouveau type de fichier, il faut pour
cela remplacer la section <code>contributes</code> dans le fichier <code>package.json</code> par :</p>
<pre><code class="language-json">"contributes": {
  "languages": [{
    "id": "kale",
    "extensions": [ ".kl" ],
    "aliases": [ "Kale" ]
  }]
}
</code></pre>
<p>Démarrez de nouveau l'instance de test de l'IDE (<code>F5</code>) et ouvrez le fichier <code>examples/simple_example.kl</code> (<code>CTRL+O</code>),
vous pouvez constater que le type de fichier est bien reconnu avec l'apparition du type de fichier <code>Kale</code> (au lieu de <code>Plain Text</code>)
dans la barre de statut en bas à droite.</p>
<p>A part reconnaître un type de fichier, l'extension ne fait, pour l'instant, pas grand chose.
Pour aller un peu plus loin il est possible de définir une autre contribution :</p>
<pre><code class="language-json">"grammars": [{
  "language": "kale",
  "scopeName": "source.kale",
  "path": "syntax-kale.json"
}]
</code></pre>
<p>Cette contribution permet de définir la coloration syntaxique pour le langage <code>kale</code>.
La définition du langage utilise le formalisme de l'éditeur de texte <a href="https://manual.macromates.com/en/language_grammars">TextMate</a>.
Créer le fichier <code>syntax-kale.json</code> à la racine de l'extension avec le contenu suivant :</p>
<pre><code class="language-json">{
  "scopeName": "source.kale",
  "patterns": [
    {
      "name": "comment.double-slash.kale",
      "match": "//.*\\n"
    },
    {
      "match": "\\b(\\w+)\\s*(:=)",
      "captures": {
        "1": {
          "name": "entity.name.other.kale"
        },
        "2": {
          "name": "punctuation.definition.entity.kale"
        }
      }
    },
    {
      "match": "\\d+",
      "name": "constant.numeric.integer.kale"
    },
    {
      "name": "string.quoted.double.kale",
      "begin": "\"",
      "end": "\""
    }
  ]
}
</code></pre>
<p>L'éditeur dispose maintenant de la coloration syntaxique (ou plutôt lexicale pour être exact),
cette coloration dépend des catégories prédéfinies préfixées par <code>comment</code>, <code>keyword</code>, etc. et s'adapte
donc automatiquement au thème de couleurs actif.</p>
<p>Il est donc relativement facile de personnaliser l'IDE pour un nouveau langage sans écrire de code.
Ces personnalisations restent cependant très superficielles et les fonctionnalités telles que l'affichage
d'erreurs en ligne ou la complétion de code ne sont, quant-à-elles, possibles que par l'ajout de code.</p>
<p>L'activation de l'extension ne peut plus se faire sur la commande <code>sayHello</code> que nous
avons supprimée, mais sur l'ouverture d'un fichier de type Kale. Modifier le fichier <code>package.json</code>
pour inclure le code suivant :</p>
<pre><code class="language-json">"activationEvents": [
  "onLanguage:kale"
]
</code></pre>
<p>Le message dans la console de débuggage doit de nouveau apparaître à l'ouverture d'un fichier Kale.</p>
<h1 id="communication-avec-le-serveur-de-langage"><a class="header" href="#communication-avec-le-serveur-de-langage">Communication avec le serveur de langage</a></h1>
<p>Pour communiquer avec le serveur de langage et profiter de ses fonctionnalités, il est nécessaire d'ajouter une librairie cliente<sup class="footnote-reference"><a href="#1">1</a></sup> :</p>
<pre><code>npm install vscode-languageclient@9.0.1
</code></pre>
<p>Et vu que notre serveur de langage est également un package Node, pour simplifier la distribution,
on l'installe également comme une dépendance, locale cette fois pour simplifier le développement
(cela va nous permettre de modifier le serveur sans avoir à réinstaller la dépendance) :</p>
<pre><code>npm install ${CHEMIN_VERS}/kale-language-server
</code></pre>
<p>Remplacer le fichier <code>src/extension.ts</code> par le code TypeScript suivant qui se limite simplement à démarrer le serveur
en indiquant le chemin vers son point d'entrée et quel type de documents il gère :</p>
<pre><code class="language-typescript">import * as path from 'path';
import * as vscode from 'vscode';
import { LanguageClient, ServerOptions, LanguageClientOptions, TransportKind } from 'vscode-languageclient';

export function activate(context: vscode.ExtensionContext) {

    const serverModule = context.asAbsolutePath(
        path.join(
            "node_modules",
            "kale-language-server",
            "lib",
            "server.js"
        )
    );

    const serverOptions: ServerOptions = {
        module: serverModule,
        transport: TransportKind.ipc
    };

    const clientOptions: LanguageClientOptions = {
        documentSelector: [ "kale" ],
    };

    const client = new LanguageClient(
        "kale-langserver",
        "Kale Language Server",
        serverOptions,
        clientOptions
    );
       
    client.start();
}

export function deactivate() {
}
</code></pre>
<p>Ici nous profitons de facilités offertes par le fait que notre serveur s'exécute avec NodeJS, mais il est également possible
de lancer n'importe quel exécutable de son choix et de choisir le mode de communication avec le client (stdio, socket, etc.).</p>
<p>L'édition d'un fichier Kale dans l'éditeur de test permet maintenant de constater que les erreurs s'affichent automatiquement
à la frappe au clavier.</p>
<h1 id="packaging-de-lextension"><a class="header" href="#packaging-de-lextension">Packaging de l'extension</a></h1>
<p>Une fois satisfait des fonctionnalités de votre extension, il est temps de la packager pour pouvoir la distribuer à vos collègues,
pour cela installez l'outil <code>vsce</code> :</p>
<pre><code>npm install -g vsce
</code></pre>
<p>Malheureusement un <a href="https://github.com/microsoft/vscode-vsce/issues/203">bug</a> de l'outil nous force
à d'abord packager localement <code>kale-language-server</code>, pour cela créer dans le projet le fichier <code>.npmignore</code>
contenant :</p>
<pre><code>.vscode/
src/
examples/
tsconfig.json
.mocharc.json
.gitignore
</code></pre>
<p>afin d'exclure les fichiers servant uniquement au développement. Puis lancez la commande :</p>
<pre><code>npm pack
</code></pre>
<p>afin de packager le projet et d'obtenir le <code>.tar.gz</code> correspondant.</p>
<p>Enfin dans le projet d'extension, ajouter dans le fichier <code>package.json</code> le champ <code>publisher</code> avec par exemple votre nom.
Si vous voulez publier l'extension sur le MarketPlace VSCode, ce nom devra d'abord avoir été déclaré en vous enregistrant.</p>
<p>Ensuite il faut remplacer la dépendance directe sur le répertoire du projet du serveur de langage par une référence sur le
<code>.tar.gz</code> et utiliser <code>vsce</code> afin de packager l'extension :</p>
<pre><code class="language-bash">npm install ${CHEMIN_VERS}/kale-language-server/kale-language-server-1.0.0.tgz
vsce package
</code></pre>
<p>ce qui permet enfin d'obtenir le package d'extension <code>.vsix</code>. Depuis VSCode, cette extension peut être installée avec
la commande <code>Extensions: install from VSIX...</code> (<code>CTRL-SHIFT-P</code> pour ouvrir la palette).</p>
<p>Il est à noter que dans le cas d'une extension embarquant la partie cliente et serveur, le projet devrait adopter l'organisation de
fichiers de l'exemple <a href="https://github.com/microsoft/vscode-extension-samples/tree/master/lsp-sample">officiel</a> afin de simplifier la gestion
des dépendances et du packaging.</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>La version majeure 7.x de <code>vscode-languageclient</code> a malheureusement une API incompatible. il y a encore du pain sur la planche...</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../03_ExtensionVSCode/02_ServeurLangage.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../03_ExtensionVSCode/04_ExtensionVim.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../03_ExtensionVSCode/02_ServeurLangage.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../03_ExtensionVSCode/04_ExtensionVim.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
